<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Source | Google Sheets & Gmail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-900">

<div id="app" class="min-h-screen">
    <header class="bg-indigo-700 text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">AutoRFQ Dispatcher</h1>
            <p class="text-indigo-200">Connected to Google Sheet: <span class="underline text-white">Live Database</span></p>
        </div>
    </header>

    <main class="container mx-auto py-10 px-4">
        <div class="max-w-4xl mx-auto">
            
            <div class="bg-white p-8 rounded-2xl shadow-sm mb-6 border border-slate-200">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
                    Choose RFQ Category
                </h2>
                <div class="flex flex-wrap gap-3">
                    <button v-for="cat in uniqueCategories" @click="selectedCategory = cat"
                        :class="selectedCategory === cat ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-50 text-slate-600 border border-slate-200'"
                        class="px-6 py-3 rounded-xl font-bold transition-all">
                        {{ cat }}
                    </button>
                </div>
            </div>

            <div v-if="selectedCategory" class="bg-white p-8 rounded-2xl shadow-sm mb-6 border border-slate-200 animate-fade-in">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">2</span>
                    Targeted Vendors ({{ targetedVendors.length }})
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="v in targetedVendors" class="p-4 bg-slate-50 rounded-lg border border-slate-100 flex justify-between">
                        <div>
                            <p class="font-bold text-slate-800">{{ v.Name }}</p>
                            <p class="text-xs text-slate-500">{{ v.Email }}</p>
                        </div>
                        <span class="text-green-500 text-xs font-bold self-center">READY</span>
                    </div>
                </div>
            </div>

            <div v-if="selectedCategory" class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">3</span>
                    RFQ Message
                </h2>
                <textarea v-model="rfqMessage" class="w-full h-40 p-4 bg-slate-50 border rounded-xl mb-6 focus:ring-2 focus:ring-indigo-500 outline-none" 
                    placeholder="Describe the items you need to source..."></textarea>
                
                <button @click="bulkSendEmails" :disabled="sending || targetedVendors.length === 0"
                    class="w-full py-4 bg-indigo-600 text-white rounded-xl font-black text-xl hover:bg-indigo-700 transition shadow-xl disabled:bg-slate-300">
                    {{ sending ? 'SENDING IN PROGRESS...' : 'DISPATCH TO ALL VENDORS' }}
                </button>
            </div>

        </div>
    </main>
</div>

<script>
    // --- SETTINGS ---
    const GOOGLE_SHEET_CSV_URL = "YOUR_PUBLISHED_CSV_URL_HERE";
    const EMAILJS_KEY = "YOUR_PUBLIC_KEY";
    const SERVICE_ID = "YOUR_SERVICE_ID";
    const TEMPLATE_ID = "YOUR_TEMPLATE_ID";

    emailjs.init(EMAILJS_KEY);

    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const allVendors = ref([]);
            const selectedCategory = ref('');
            const rfqMessage = ref('');
            const sending = ref(false);

            // Fetch live data from Google Sheets
            const loadData = () => {
                Papa.parse(GOOGLE_SHEET_CSV_URL, {
                    download: true,
                    header: true,
                    complete: (results) => {
                        allVendors.value = results.data;
                    }
                });
            };

            const uniqueCategories = computed(() => {
                const cats = new Set(allVendors.value.map(v => v.Category).filter(c => c));
                return Array.from(cats);
            });

            const targetedVendors = computed(() => {
                return allVendors.value.filter(v => v.Category === selectedCategory.value);
            });

            const bulkSendEmails = async () => {
                if (!confirm(`Are you sure you want to send this RFQ to ${targetedVendors.value.length} vendors?`)) return;
                
                sending.value = true;
                let successCount = 0;

                for (const vendor of targetedVendors.value) {
                    try {
                        await emailjs.send(SERVICE_ID, TEMPLATE_ID, {
                            vendor_name: vendor.Name,
                            to_email: vendor.Email,
                            message: rfqMessage.value,
                            category: selectedCategory.value
                        });
                        successCount++;
                    } catch (err) {
                        console.error(`Failed to send to ${vendor.Email}`, err);
                    }
                }

                alert(`Done! ${successCount} out of ${targetedVendors.value.length} RFQs were successfully dispatched.`);
                sending.value = false;
                rfqMessage.value = '';
            };

            onMounted(loadData);

            return { uniqueCategories, selectedCategory, targetedVendors, rfqMessage, sending, bulkSendEmails };
        }
    }).mount('#app')
</script>
</body>
</html>
